
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>성과관리 면담 시뮬레이터</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }

          body {
  font-family: 'Noto Sans KR', -apple-system, BlinkMacSystemFont, sans-serif;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  min-height: 100vh; display: flex; align-items: center; justify-content: center;
  padding: 20px;
}

/* 레포트 본문: 줄바꿈 보존 + 약간 여백 */
#modalSummaryContent {
  white-space: pre-line;   /* \n 줄바꿈 유지 */
  letter-spacing: 0.1px;   /* 가독성 미세 개선 */
}


/* ===== [수정] 평가 섹션(A,B,C,D) 전용 스타일 ===== */
/* ===== 평가 섹션(A,B,C,D) 전용 스타일 ===== */
.evaluation-item {
    margin-bottom: 16px; /* A와 B, B와 C 등 각 항목 사이의 간격을 만듭니다. */
}
.evaluation-item:last-child {
    margin-bottom: 0; /* 마지막 항목 뒤에는 간격을 주지 않습니다. */
}

.evaluation-item strong {
    display: block; /* 제목을 한 줄로 독립시킵니다. */
    font-size: 16px;
    font-weight: 700;
    margin-bottom: 3px; /* 제목과 내용 사이의 작은 간격 */
}

.evaluation-item .evaluation-description {
    margin: 0; /* 브라우저 기본 여백 제거 */
    padding-left: 20px; /* 들여쓰기 효과 */
    border-left: 3px solid #e9ecef; /* 왼쪽에 구분선 추가 */
    color: #495057;
    line-height: 1.4;
}



    .container { width: 100%; max-width: 1200px; margin: 0 auto; }
    .hidden { display: none !important; }

    /* ===== Hero (Start) ===== */
    .hero {
      position: relative; width: 100%; max-width: 820px; margin: 0 auto;
      background: #fff; border-radius: 18px; overflow: hidden;
      box-shadow: 0 10px 30px rgba(0,0,0,0.12);
    }
    .hero-wrap { position: relative; width: 100%; padding-top: 58%; }
    .hero-img {
      position: absolute; inset: 0; width: 100%; height: 100%; object-fit: cover; display: block;
      filter: brightness(0.75);
    }
    .hero-text-content {
      position: absolute; top: 8%; left: 50%; transform: translateX(-50%);
      color: #fff; text-align: center; width: 92%; text-shadow: 0 2px 4px rgba(0,0,0,0.5);
    }
    .hero-text-content h1 { font-size: 2rem; margin-bottom: .6rem; }
    .hero-text-content p { font-size: 1.05rem; opacity: .95; }
    .start-btn-center {
      position: absolute; bottom: 8%; left: 50%; transform: translateX(-50%);
      padding: 14px 38px; border-radius: 999px; border: 2px solid #fff;
      font-weight: 700; font-size: 1.05rem; color: #fff; background: rgba(0,0,0,.2);
      cursor: pointer; transition: all .25s ease;
    }
    .start-btn-center:hover { background: #fff; color: #333; }

    /* ===== Content Cards & Layout ===== */
    .content {
      background: #fff; border-radius: 16px; padding: 28px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.1);
    }
    .selection-grid {
      display: grid; gap: 18px; grid-template-columns: repeat(2, 1fr);
    }
    .card {
      position: relative; background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
      border-radius: 16px; padding: 18px; cursor: pointer; transition: .25s ease;
      border: 2px solid transparent; min-height: 140px; overflow: hidden;
      display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center;
    }
    .card:hover { transform: translateY(-4px); box-shadow: 0 10px 24px rgba(0,0,0,.18); border-color: #667eea; }
    .card h3 { font-size: 18px; color: #222; margin-top: 10px; }
    .card p { font-size: 13px; color: #555; margin-top: 6px; }

    .info-badge {
      position: absolute; top: 10px; right: 10px;
      background: #667eea; color: #fff; padding: 5px 10px; border-radius: 999px;
      font-size: 12px; font-weight: 600;
    }

    /* Persona circular image */
    .avatar-round {
      width: 84px; height: 84px; border-radius: 50%; object-fit: cover;
      border: 3px solid rgba(255,255,255,0.9); box-shadow: 0 4px 10px rgba(0,0,0,0.12);
      background: #fff;
    }

    /* Buttons */
    .back-button {
      appearance: none; background: #6c757d; color: #fff;
      border: none; padding: 10px 18px; border-radius: 10px; cursor: pointer; font-size: 14px;
      transition: .25s ease;
    }
    .back-button:hover { background: #5a6268; transform: translateY(-1px); }
    .start-button {
      appearance: none; border: none; border-radius: 10px; color: #fff; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      padding: 12px 22px; font-weight: 700; font-size: 15px; cursor: pointer; transition: .25s ease;
    }
    .start-button:hover { transform: scale(1.03); box-shadow: 0 5px 15px rgba(102,126,234,0.35); }

    /* ===== Advanced persona form ===== */
    .advanced-form { animation: fadeIn .25s ease; }
    .form-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px; }
    .form-group { display: flex; flex-direction: column; }
    .form-group.full-width { grid-column: 1 / -1; }
    .form-group label { font-size: 13px; font-weight: 700; color: #444; margin-bottom: 6px; }
    .form-group input, .form-group select {
      width: 100%; padding: 10px 12px; border-radius: 8px; border: 1px solid #ccc; font-size: 14px;
    }
/* ===== EXHIBITION READABILITY IMPROVEMENTS (Global) ===== */

/* ===== [신규 추가] 면담 배워보기 카드 스타일 ===== */
.tip-card-container {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); /* 반응형 그리드 */
    gap: 15px; /* 카드 사이 간격 */
    margin-top: 10px;
}

.tip-card {
    background-color: #ffffff;
    border: 1px solid #dee2e6;
    border-radius: 12px;
    padding: 14px 18px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.05);
}

.tip-card h5 {
    font-size: 16px;
    font-weight: 700;
    color: #343a40;
    margin-bottom: 12px;
}

.tip-card ul {
    list-style-type: none; /* 기본 불릿 제거 */
    padding-left: 0;
}

.tip-card li {
    position: relative;
    padding-left: 22px; /* 아이콘 들어갈 공간 확보 */
    margin-bottom: 8px;
    color: #495057;
    line-height: 1.5;
}

/* 리스트 아이템 앞 아이콘 스타일 */
.tip-card li::before {
    content: '✅'; /* 기본 아이콘 */
    position: absolute;
    left: 0;
    top: 2px;
    font-size: 14px;
}


/* 전체 폰트 크기 기본값 상향 조정 */
body {
  font-size: 17px; /* 기존 폰트보다 약간 크게 설정 */
}

/* 주요 제목(Hero h1) 크기 확대 */
.hero-text-content h1 {
  font-size: 2.5rem; /* 기존 2rem에서 확대 */
  margin-bottom: 0.8rem;
}
.hero-content h1 {
  font-size: 2.5rem; /* Hero Stack 타입의 제목도 확대 */
  margin-bottom: 10px;
}
.hero-text-content p, .hero-content p {
  font-size: 1.2rem; /* Hero 설명 텍스트 확대 */
}
.start-btn-center, .hero--split .start-btn, .hero-content .start-btn {
  padding: 16px 40px; /* 시작 버튼 패딩 증가 */
  font-size: 1.2rem; /* 시작 버튼 폰트 확대 */
}


/* Content Card 제목 및 설명 확대 */
.card h3 {
  font-size: 20px; /* 카드 제목 확대 */
  margin-top: 12px;
}
.card p {
  font-size: 15px; /* 카드 설명 확대 */
  margin-top: 8px;
}
.info-badge {
  font-size: 13px; /* 정보 뱃지 폰트 확대 */
  padding: 6px 11px;
}
.avatar-round {
  width: 92px; /* 아바타 이미지 크기 약간 확대 */
  height: 92px;
}

/* 버튼 폰트 및 패딩 확대 */
.back-button, .start-button {
  font-size: 15px; /* 일반 버튼 폰트 확대 */
  padding: 12px 20px;
}

/* Chat UI 폰트 크기 및 간격 조정 */
.bubble {
  font-size: 15px; /* 채팅 버블 폰트 확대 */
  padding: 12px 16px;
}
.bubble { line-height: 1.6; }  /* 줄 높이로 읽기 편하게 */

.input input {
  font-size: 15px; /* 채팅 입력창 폰트 확대 */
  padding: 14px 18px; /* 입력창 높이 증가 */
}
.input button {
  font-size: 14px; /* 채팅 전송/종료 버튼 폰트 확대 */
  padding: 11px 18px;
}
.name {
  font-size: 11px; /* 이름 라벨 폰트 확대 */
  margin-left: 62px; /* 아바타 크기 변경에 따른 이름 위치 조정 */
}
.chat .avatar {
  width: 55px; /* 채팅 아바타 크기 확대 */
  height: 55px;
  flex: 0 0 55px;
}

/* Coach Tip 폰트 확대 및 간격 조정 */
.coach-tip-new {
  font-size: 15px; /* 코치 팁 본문 폰트 확대 */
  padding: 18px;
}
.coach-choice {
  font-size: 14px; /* 코치 팁 선택지 폰트 확대 */
  padding: 11px 14px;
}
.coach-analysis {
  margin-bottom: 14px;
}

/* 모달 제목 및 내용 확대 */
.modal-content h3 {
  font-size: 24px; /* 모달 제목 확대 */
  margin-bottom: 16px;
  padding-bottom: 14px;
}
.evaluation-score {
  font-size: 20px; /* 종합 점수 확대 */
}
.modal-summary-content {
  font-size: 16px; /* 모달 요약 내용 확대 */
  line-height: 1.9; /* 줄 간격 확대 */
  padding: 12px;
}
.modal-actions button {
  font-size: 15px; /* 모달 버튼 폰트 확대 */
  padding: 11px 18px;
}

/* 카테고리 보드 텍스트 확대 */
.cat .label {
  font-size: 14px; /* 카테고리 라벨 폰트 확대 */
}
.cat .score {
  font-size: 13px; /* 카테고리 점수 폰트 확대 */
}


/* 미디어 쿼리 조정 (모바일에서도 글씨 크기 유지) */
@media (max-width: 640px) {
  .hero-text-content h1 { font-size: 2rem; } /* 모바일 Hero 제목 조정 */
  .hero-content h1 { font-size: 2rem; }
  .hero-text-content p, .hero-content p { font-size: 1.1rem; }
  .start-btn-center, .hero--split .start-btn, .hero-content .start-btn {
    padding: 14px 30px;
    font-size: 1.1rem;
  }
}


/* ===== Advanced persona form READABILITY IMPROVEMENTS (강화) ===== */
.form-grid {
  gap: 20px 18px; /* 항목 간 간격 조정 */
}
.form-group label {
  font-size: 16px;      /* 라벨 폰트 크기 증가 */
  color: #333;
  margin-bottom: 10px;   /* 라벨과 드롭박스 사이 간격 증가 */
}
.form-group input,
.form-group select {
  width: 100%;
  padding: 16px 14px;   /* 드롭박스 및 입력창 높이 더 증가 */
  border-radius: 10px;  /* 모서리 둥글게 */
  border: 1px solid #bbb; /* 테두리 색상 조정 */
  font-size: 17px;      /* 입력창/드롭박스 폰트 크기 증가 */
  appearance: none;     /* 브라우저 기본 드롭박스 스타일 제거 (화살표 커스텀을 위해) */
  background-color: #f8f8f8; /* 배경색 추가 */
  cursor: pointer;      /* 마우스 오버 시 커서 변경 */
  transition: all 0.2s ease; /* 부드러운 전환 효과 */
}

/* 드롭박스 화살표 커스텀 (appearance: none 때문에 필요) */
.form-group select {
  background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23666666%22%20d%3D%22M287%20169.16l-11.45%2011.45L146.2%2056.45%2011.45%20169.16%200%20157.71l146.2-146.2%20146.2%20146.2z%22%2F%3E%3C%2Fsvg%3E');
  background-repeat: no-repeat;
  background-position: right 14px center; /* 화살표 위치 조정 */
  background-size: 14px; /* 화살표 크기 조정 */
}


/* 포커스 시 스타일 변경 (선택하기 편하도록 시각적 강조) */
.form-group input:focus,
.form-group select:focus {
  border-color: #667eea; /* 포커스 시 테두리 색상 강조 */
  box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.2); /* 포커스 시 그림자 효과 */
  background-color: #fff; /* 포커스 시 배경색 변경 */
  outline: none; /* 기본 아웃라인 제거 */
}

/* 호버 시 스타일 변경 */
.form-group select:hover {
  border-color: #8899ee; /* 호버 시 테두리 색상 변경 */
  background-color: #f0f0f0;
}

    /* ===== Chat (kept intact) ===== */
    .chat { display: none; grid-template-rows: auto 1fr auto auto; gap:15px; height: 85vh;
      background:#fff; border-radius:15px; padding:20px; box-shadow:0 5px 20px rgba(0,0,0,0.1); }
    .messages { background:#F6F7F9; border:1px solid #E8EAED; border-radius:12px; padding:16px; overflow-y:auto; height:100%; }
    .row { display:flex; gap:8px; margin:8px 0; align-items:flex-start; }
    .row.user { justify-content:flex-end; }
    .row.bot { justify-content:flex-start; }
    .avatar { width: 50px; height: 50px; border-radius: 50%; flex: 0 0 50px; overflow: hidden; }
    .avatar img { width: 100%; height: 100%; border-radius: 50%; object-fit: cover; }
    .name { font-size:10px; color:#666; margin-left:58px; margin-top:-4px; font-weight:500; }
    .bubble { max-width:70%; padding:10px 14px; border-radius:18px; font-size:14px; line-height:1.4; box-shadow:0 2px 8px rgba(0,0,0,0.08); word-wrap:break-word; }
    .bubble.user { background:linear-gradient(135deg,#667eea 0%,#764ba2 100%); color:#fff; border-bottom-right-radius:4px; }
    .bubble.bot { background:#fff; color:#333; border-bottom-left-radius:4px; border:1px solid #f0f0f0; }
    .input { display:flex; gap:8px; align-items:center; }
    .input input { flex:1; border:2px solid #E8EAED; border-radius:25px; padding:12px 16px; font-size:14px; outline:none; transition:border-color 0.3s; }
    .input input:focus { border-color:#667eea; box-shadow:0 0 0 3px rgba(102,126,234,0.1); }
    .input button { appearance:none; border:0; border-radius:20px; padding:10px 16px; font-weight:600; font-size:13px; background:linear-gradient(135deg,#667eea 0%,#764ba2 100%); color:#fff; cursor:pointer; transition:transform 0.2s; }
    .input button:hover { transform:scale(1.02); }
    .input button:active { transform:scale(0.98); }
    .typing { background:#fff; border-radius:18px; border-bottom-left-radius:4px; padding:8px 12px; width:fit-content; box-shadow:0 2px 8px rgba(0,0,0,0.08); border:1px solid #f0f0f0; }
    .dots { display:inline-grid; grid-auto-flow:column; gap:3px; }
    .dots span { width:5px; height:5px; background:#bbb; border-radius:50%; animation: blink 1.2s infinite; }
    .dots span:nth-child(2){ animation-delay: .2s; }
    .dots span:nth-child(3){ animation-delay: .4s; }
    @keyframes blink { 0%,80%,100%{opacity:.3} 40%{opacity:1} }
    .summary { display:none; background:#f8fff8; border:1px solid #d4edda; border-radius:10px; padding:15px; font-size:13px; line-height:1.5; max-height:150px; overflow-y:auto; }

    /* === Coach tip styles (kept) === */
    .coach-tip-new {
      font-size: 14px; color: #333; background: #f8f9fa; border: 1px solid #e9ecef;
      border-radius: 18px; border-bottom-left-radius: 4px; padding: 15px; max-width: 70%;
      line-height: 1.6; box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }
    .coach-analysis { margin-bottom: 12px; }
    .coach-choices { border-top: 1px dashed #dfe7e3; padding-top: 12px; display: flex; flex-direction: column; gap: 8px; }
    .coach-choice { background: #fff; border: 1px solid #dfe7e3; border-radius: 10px; padding: 10px 12px; cursor: pointer; transition: background-color .2s, box-shadow .2s; font-size: 13px; color: #0056b3; }
    .coach-choice:hover { background: #e9f5ff; border-color: #b3d7ff; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
    .coach-choice.disabled { cursor: default; background: #f8f9fa; color: #6c757d; opacity: .7; text-decoration: line-through; }
    .row.coach { align-items: flex-start; }

    /* === Modal (summary) === */
    .modal {
      display: none; position: fixed; z-index: 1000; inset: 0;
      background: rgba(0,0,0,.6); justify-content: center; align-items: center;
    }
    .modal-content {
      background: #fff; padding: 26px; border-radius: 16px; width: 92%; max-width: 820px; max-height: 85vh;
      display: flex; flex-direction: column;
    }
    .modal-content h3 { margin-bottom: 14px; font-size: 22px; color: #333; text-align: center; border-bottom: 2px solid #eee; padding-bottom: 12px; }
    .evaluation-signal { display: flex; align-items: center; gap: 12px; padding-bottom: 12px; margin-bottom: 12px; border-bottom: 1px solid #eee; }
    .traffic-light { width: 24px; height: 24px; border-radius: 50%; background: #ddd; }
    .traffic-light.green { background: #28a745; } .traffic-light.yellow { background: #ffc107; } .traffic-light.red { background: #dc3545; }
    .evaluation-score { font-size: 18px; font-weight: 800; color: #333; }
    .modal-summary-content { flex: 1; overflow-y: auto; line-height: 1.8; font-size: 15px; padding: 10px; background: #f8f9fa; border: 1px solid #e9ecef; border-radius: 8px; }
    .modal-actions { margin-top: 18px; display: flex; gap: 8px; justify-content: flex-end; flex-wrap: wrap; }
    .modal-actions button { padding: 10px 16px; border: none; border-radius: 8px; font-size: 14px; font-weight: 700; cursor: pointer; }
    .btn-download { background: #28a745; color: #fff; } .btn-email { background: #007bff; color: #fff; } .btn-back { background: #6c757d; color: #fff; }

    /* Mic button */
    #recordButton { width: 40px; height: 40px; border-radius: 50%; padding: 0; font-size: 18px; background: #f1f2f6; color: #57606f; border: 1px solid #dcdde1; }
    #recordButton.recording { background: #e84118; color: #fff; border-color: #c23616; animation: pulse 1.5s infinite; }
    @keyframes pulse {
      0% { box-shadow: 0 0 0 0 rgba(232,65,24,0.4); }
      70% { box-shadow: 0 0 0 10px rgba(232,65,24,0); }
      100% { box-shadow: 0 0 0 0 rgba(232,65,24,0); }
    }
/* === Category board (관계/과정/성과) === */
    .category-board {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
      margin: 6px 0 12px;
    }
    @media (min-width: 720px){ .category-board { grid-template-columns: 1fr 1fr 1fr; } }
    .cat {
      display:flex; align-items:center; gap:10px;
      padding: 8px 10px; border:1px solid #eee; border-radius:10px; background:#fff;
    }
    .cat .traffic-light { width:12px; height:12px; }
    .cat .label { flex:1; font-weight:600; font-size:13px; color:#333; }
    .cat .score { font-size:12px; color:#666; }

    @media (max-width: 640px) {
      .hero-wrap { padding-top: 72%; }
      .hero-text-content h1 { font-size: 1.6rem; }
      .selection-grid { grid-template-columns: 1fr; }
      .form-grid { grid-template-columns: 1fr; }
    }

    @keyframes fadeIn { from { opacity: 0; transform: translateY(6px); } to { opacity: 1; transform: translateY(0); } }
  
/* === HERO SPLIT (2-column) === */
.hero.hero--split{ background: transparent; box-shadow: none; }
.hero--split .hero-inner{
  display: grid; grid-template-columns: 0.8fr 1.2fr;
  align-items: center; gap: 28px;
  background: #fff; border-radius: 18px; padding: 32px;
  box-shadow: 0 10px 30px rgba(0,0,0,0.12);
}
.hero--split .hero-left h1{ font-size: 2.2rem; margin-bottom: 10px; }
.hero--split .hero-left p{ font-size: 1.05rem; opacity: .9; }
.hero--split .start-btn{
  margin-top: 16px; padding: 12px 28px; border-radius: 999px;
  border: 2px solid #667eea;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: #fff; font-weight: 700; font-size: 1.05rem; cursor: pointer;
  transition: .25s ease;
}
.hero--split .start-btn:hover{ transform: translateY(-1px); box-shadow: 0 8px 22px rgba(102,126,234,0.35); }
.hero--split .hero-right img{
  width: 100%; height: auto; display: block; border-radius: 12px;
}
@media (max-width: 800px){
  .hero--split .hero-inner{ grid-template-columns: 1fr; padding: 22px; text-align: center; }
  .hero--split .hero-right{ order: -1; }
}


/* === HERO STACK (image top, content bottom) === */
.hero.hero--stack{ background: transparent; box-shadow: none; }
.hero-card{
  background:#fff; border-radius: 18px; overflow: hidden;
  box-shadow: 0 10px 30px rgba(0,0,0,0.12);
  max-width: 1200px; margin: 0 auto;
}
.hero-media{ aspect-ratio: 16/9; background:#2d2a4a; }
.hero-media img{ width:100%; height:100%; object-fit: cover; display:block; }
.hero-content{ text-align:center; padding: 22px 24px 28px; }
.hero-content h1{ font-size: 2.2rem; margin-bottom: 8px; }
.hero-content p{ font-size: 1.05rem; opacity: .9; margin-bottom: 16px; }
.hero-content .start-btn{
  padding: 12px 28px; border-radius: 999px; border: 2px solid #667eea;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: #fff; font-weight: 700; font-size: 1.05rem; cursor: pointer;
  transition: .25s ease;
}
.hero-content .start-btn:hover{ transform: translateY(-1px); box-shadow: 0 8px 22px rgba(102,126,234,0.35); }

@media (max-width: 640px){
  .hero-media{ aspect-ratio: 4/3; } /* 모바일에서 조금 더 세로 확보 */
  .hero-content h1{ font-size: 1.7rem; }
}
/* container 넓이 보정(있으면 상향) */
.container{ max-width: 1200px; }


/* ===== Coach Tip Modal Button Style ===== */
.coach-choice-button {
    width: 100%;
    padding: 14px;
    font-size: 15px;
    font-weight: 600;
    color: #0056b3;
    background-color: #fff;
    border: 1px solid #b3d7ff;
    border-radius: 10px;
    cursor: pointer;
    text-align: left;
    transition: background-color 0.2s, box-shadow 0.2s;
}
.coach-choice-button:hover {
    background-color: #e9f5ff;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
}
/* ===== Coach Action Bar & Button Style (NEW) ===== */
.coach-action-bar {
  display: flex;
  align-items: center;
  justify-content: flex-end; /* 우측 정렬 */
  padding: 10px 0;
  gap: 10px;
  width: 100%;
}

.coach-action-bar .coach-avatar {
  width: 45px;
  height: 45px;
  border-radius: 50%;
  border: 2px solid #667eea;
}

.coach-analysis-button {
  padding: 10px 20px;
  font-size: 14px;
  font-weight: 600;
  color: #fff;
  background-color: #667eea;
  border: none;
  border-radius: 25px;
  cursor: pointer;
  box-shadow: 0 4px 10px rgba(102, 126, 234, 0.3);
  transition: background-color 0.2s ease, transform 0.2s ease;
}

.coach-analysis-button:hover {
  background-color: #556cdc;
  transform: translateY(-2px);
}

/* 코치 팝업 닫기 버튼 */
.modal-close-button {
  position: absolute;
  top: 15px;
  right: 15px;
  background: none;
  border: none;
  font-size: 24px;
  font-weight: bold;
  color: #888;
  cursor: pointer;
}
.modal-close-button:hover {
  color: #333;
}
/* ===== 시나리오 선택 화면 가독성 증가 ===== */
#stageSelection .card h3 {
  font-size: 24px; /* 제목 폰트 크기 증가 */
  margin-bottom: 8px; /* 제목과 설명 사이 간격 조정 */
}

#stageSelection .card p {
  font-size: 16px; /* 설명 폰트 크기 증가 */
  line-height: 1.6; /* 문장이 두 줄이 될 경우를 대비해 줄 간격 확보 */
}
/* ===== Advanced Persona Form Layout Adjustments ===== */
#advancedForm .advanced-form {
  padding: 20px; /* 전체적인 내부 여백을 약간 줄입니다. */
}

#advancedForm h2 {
  font-size: 20px; /* 제목 폰트 크기를 약간 줄입니다. */
  margin-bottom: 20px; /* 제목 아래 여백을 줄입니다. */
}

#advancedForm .form-grid {
  gap: 14px 16px; /* 항목 간의 상하/좌우 간격을 줄입니다. */
}

#advancedForm .form-group label {
  font-size: 14px;      /* 라벨 폰트 크기를 줄입니다. */
  margin-bottom: 6px;   /* 라벨과 입력창 사이 간격을 줄입니다. */
}

#advancedForm .form-group input,
#advancedForm .form-group select {
  font-size: 15px;      /* 입력창 폰트 크기를 약간 줄입니다. */
  padding: 12px 14px;   /* 입력창의 상하 높이를 줄입니다. */
}

#advancedForm .back-button,
#advancedForm .start-button {
  padding: 10px 18px; /* 하단 버튼들의 크기를 약간 줄입니다. */
  font-size: 14px;
}

/* ===== 가이드 팝업 가독성 개선 ===== */
#guidanceContentWrapper h4 {
  margin-top: 16px; /* 각 섹션 제목 위에 여백을 주어 구분을 명확하게 합니다. */
}
#guidanceContentWrapper h4:first-child {
  margin-top: 0; /* 단, 첫 번째 제목 위에는 여백을 주지 않습니다. */
}
#guidanceContentWrapper p {
  padding-left: 20px;  /* 모든 설명 텍스트에 왼쪽 여백(들여쓰기)을 적용합니다. */
  white-space: pre-line; /* \n 줄바꿈 문자를 자동으로 인식하게 합니다. */
}
.followup-banner{display:none;position:sticky;top:0;z-index:50;background:#F1F5FF;border:1px solid #C7D2FE;border-radius:12px;padding:10px 14px;margin:8px 0}
.followup-banner.show{display:block}
.followup-banner .actions{display:flex;gap:8px;margin-top:6px}
.followup-banner button{border-radius:10px;padding:8px 12px;border:1px solid #CBD5E1;background:#fff;cursor:pointer}

/* ===== 3단 리포트 스타일 (신규 추가) ===== */
.report-container {
    display: flex;
    flex-direction: column;
    gap: 15px;
    flex: 1;
    overflow-y: auto;
    min-height: 0;
}
.report-container {
    display: flex;
    flex-direction: column; /* 아이템들을 세로로 정렬 */
    gap: 15px; /* 각 report-block 사이의 간격 */
    flex: 1;
    overflow-y: auto; /* 내용이 길어지면 이 컨테이너 자체가 스크롤됩니다. */
    min-height: 0;
    padding-right: 10px; /* 스크롤바 공간 확보 */
}

/* 기존 report-block 내부의 padding 조절 (가독성을 위해) */
.report-block {
    background: #f8f9fa;
    border: 1px solid #e9ecef;
    border-radius: 8px;
    padding: 20px; /* 기존 15px에서 20px로 약간 늘려 여백 확보 */
    flex-shrink: 0; /* 내용이 적어도 블록 크기가 줄어들지 않도록 */
}

.report-block h4 {
    margin-bottom: 10px;
    padding-bottom: 10px; /* 라인과의 간격 확보 */
    border-bottom: 1px solid #dee2e6;
    font-size: 18px; /* 헤더 글씨 크기 약간 키움 */
    font-weight: 700;
}

.report-block .modal-summary-content {
    padding: 0;
    border: none;
    background: transparent;
    font-size: 15px;
    line-height: 1.7; /* 줄 간격 넓혀 가독성 향상 */
    white-space: pre-line; /* pre-line 대신 pre-wrap으로 수정: 공백 유지하고 자동 줄 바꿈 */
    color: #343a40; /* 텍스트 색상 명확화 */
}

.report-block .modal-summary-content p {
    margin: 0 0 10px 0; /* 단락 아래에만 약간의 간격을 둡니다. */
}

/* '면담 평가' 제목 (A, B, C, D...) */
.report-block .evaluation-title {
    display: block;
    font-size: 16px;
    font-weight: 700;
    margin: 18px 0 6px 0; /* 각 평가 항목 위에 충분한 간격을 둡니다. */
}
.report-block .evaluation-title:first-child {
    margin-top: 0; /* 단, 첫 번째 항목 위에는 간격을 주지 않습니다. */
}

/* '면담 평가' 설명 */
.report-block .evaluation-description {
    margin: 0 !important; /* 다른 스타일과 충돌하지 않도록 margin을 강제 초기화 */
    padding-left: 20px;
    border-left: 3px solid #e9ecef;
    color: #495057;
    line-height: 1.6;
}

/* [수정 제안] 배워보기 섹션의 첫 카드 컨테이너 상단 여백 제거 */
#reportBlock3 > p + .tip-card-container {
    margin-top: 0;
}

/* category-board 스타일 수정 */
.category-board {
    margin-bottom: 15px;
}


</style>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

</head>
<body>
  <div class="container">
    <section id="hero" class="hero hero--stack">
      <div class="hero-card">
        <div class="hero-media">
          <img src="https://images.unsplash.com/photo-1556761175-5973dc0f32e7?auto=format&fit=crop&w=1600&q=80" alt="면담 장면" />
        </div>
        <div class="hero-content">
          <h1>성과관리 면담 시뮬레이터</h1>
          <p>실제 면담 상황을 AI와 함께 연습해보세요</p>
          <button class="start-btn" id="startBtn">시작하기</button>
        </div>
      </div>
    </section>

    <div id="mainContent" class="content hidden">

      <div id="personaSelection">
        <div class="selection-grid">
          <div class="card" onclick="selectPersona('low')" title="저성과자">
            <img class="avatar-round" src="https://cdn-icons-png.flaticon.com/512/4128/4128176.png" alt="저성과자" />
            <h3>저성과자</h3>
            <p>자신감이 낮고 방어적인 태도의 구성원</p>
          </div>
          <div class="card" onclick="selectPersona('mid')" title="중간성과자">
            <img class="avatar-round" src="https://cdn-icons-png.flaticon.com/512/4128/4128335.png" alt="중간성과자" />
            <h3>중간성과자</h3>
            <p>강점·개선점을 균형 있게 인식하는 구성원</p>
          </div>
          <div class="card" onclick="selectPersona('high')" title="고성과자">
            <img class="avatar-round" src="https://cdn-icons-png.flaticon.com/512/4128/4128253.png" alt="고성과자" />
            <h3>고성과자</h3>
            <p>임팩트를 강조하고 지원을 명확히 요청하는 구성원</p>
          </div>
          <div class="card" onclick="selectPersona('custom')" title="성격고르기">
            <img class="avatar-round" src="https://cdn-icons-png.flaticon.com/512/3135/3135715.png" alt="성격고르기" onerror="this.src='https://cdn-icons-png.flaticon.com/512/4128/4128335.png';" />
            <span class="info-badge">성격고르기</span>
            <h3>맞춤 성격 설정</h3>
            <p>직군/직무/장단점 등 세부 특성을 직접 설정</p>
          </div>
        </div>
        <div style="margin-top:16px;">
          <button class="back-button" onclick="goToStart()">← 처음으로</button>
        </div>
      </div>

<div id="advancedForm" class="hidden">
        <div class="advanced-form">
          <h2 style="text-align: center; font-size: 22px; margin-bottom: 24px;">맞춤 성격 설정</h2>
          <div class="form-grid">
            <div class="form-group">
              <label for="advRank">직급</label>
              <select id="advRank">
                <option value="기정">기정</option>
                <option value="주임">주임</option>
                <option value="사원">사원</option>
              </select>
            </div>
            <div class="form-group">
              <label for="advYears">직급 연차</label>
              <select id="advYears">
                </select>
            </div>
            <div class="form-group">
              <label for="advJob">직무</label>
              <select id="advJob">
                <option value="생산">생산</option>
                <option value="검사">검사</option>
                <option value="장비">장비</option>
                <option value="품질">품질</option>
                <option value="기타">기타</option>
              </select>
            </div>
            <div class="form-group">
              <label for="advRole">직군</label>
              <select id="advRole">
                <option value="OP">OP</option>
                <option value="Tech">Tech</option>
              </select>
            </div>
            <div class="form-group">
              <label for="advPerformance">성과수준</label>
              <select id="advPerformance">
                <option value="low">저성과자</option>
                <option value="mid">중간성과자</option>
                <option value="high">고성과자</option>
              </select>
            </div>
            <div class="form-group">
              <label for="advPerformanceDetail">면담 태도</label>
              <select id="advPerformanceDetail">
                <option value="적극적인">적극적인</option>
                <option value="소극적인">소극적인</option>
                <option value="방어적인">방어적인</option>
                <option value="수용적인">수용적인</option>
                <option value="도전적인">도전적인</option>
              </select>
            </div>
            <div class="form-group">
              <label>성격의 장점</label>
              <select id="advPersonalityStrengthsSelect">
                <option value="책임감이 강함">책임감이 강함</option>
                <option value="긍정적">긍정적</option>
                <option value="성실함">성실함</option>
                <option value="custom">직접 입력</option>
              </select>
              <input id="advPersonalityStrengthsCustom" class="hidden" type="text" placeholder="장점을 직접 입력" />
            </div>
            <div class="form-group">
              <label>성격의 단점</label>
              <select id="advPersonalityWeaknessesSelect">
                <option value="성급함">성급함</option>
                <option value="낯가림">낯가림</option>
                <option value="부정적">부정적</option>
                <option value="custom">직접 입력</option>
              </select>
              <input id="advPersonalityWeaknessesCustom" class="hidden" type="text" placeholder="단점을 직접 입력" />
            </div>
            <div class="form-group">
              <label>업무의 장점</label>
              <select id="advWorkStrengthsSelect">
                <option value="빠른 습득력">빠른 습득력</option>
                <option value="추진력">추진력</option>
                <option value="실행력">실행력</option>
                <option value="custom">직접 입력</option>
              </select>
              <input id="advWorkStrengthsCustom" class="hidden" type="text" placeholder="장점을 직접 입력" />
            </div>
            <div class="form-group">
              <label>업무의 단점</label>
              <select id="advWorkWeaknessesSelect">
                <option value="협업을 중시하지 않음">협업을 중시하지 않음</option>
                <option value="납기를 지키지 않음">납기를 지키지 않음</option>
                <option value="문서 작성이 서툼">문서 작성이 서툼</option>
                <option value="custom">직접 입력</option>
              </select>
              <input id="advWorkWeaknessesCustom" class="hidden" type="text" placeholder="단점을 직접 입력" />
            </div>
            <div class="form-group full-width">
              <label for="advNotablePoints">특이사항</label>
              <input id="advNotablePoints" type="text" placeholder="(예: 총무를 맡고 있음 등)" />
            </div>
          </div>
          <div style="display:flex; justify-content: space-between; margin-top:18px;">
            <button class="back-button" onclick="goToPersonaSelection()">← 캐릭터 다시 선택</button>
            <button class="start-button" onclick="submitAdvancedPersona()">다음 (단계 선택)</button>
          </div>
        </div>
      </div>

            <div id="stageSelection" class="hidden">
        <div class="selection-grid">
          <div class="card" onclick="showGuidancePopup('goal', 'goal', '')">
            <img class="avatar-round" src="https://cdn-icons-png.flaticon.com/512/3079/3079165.png" alt="목표설정" />
            <h3>목표설정</h3>
            <p>연초 목표 수립 면담을 연습합니다.</p>
          </div>
          <div class="card" onclick="showGuidancePopup('feedback', 'feedback', '')">
            <img class="avatar-round" src="https://cdn-icons-png.flaticon.com/512/2082/2082650.png" alt="중간피드백" />
            <h3>중간피드백</h3>
            <p>연중 성과 점검 및 코칭 대화를 연습합니다.</p>
          </div>
          <div class="card" onclick="showGuidancePopup('before', 'evaluation', 'before')">
            <img class="avatar-round" src="https://cdn-icons-png.flaticon.com/512/1589/1589665.png" alt="최종평가" />
            <h3>최종평가</h3>
            <p>평가 전 기대 수준 정렬 면담을 연습합니다.</p>
          </div>
          <div class="card" onclick="showGuidancePopup('appeal', 'evaluation', 'appeal')">
            <img class="avatar-round" src="https://cdn-icons-png.flaticon.com/512/4233/4233830.png" alt="이의제기" />
            <h3>이의제기</h3>
            <p>평가 이의제기 상황의 면담을 연습합니다.</p>
          </div>
        </div>
        <div style="margin-top:16px;">
          <button class="back-button" onclick="goToPersonaSelection()">← 캐릭터 다시 선택</button>
        </div>
      </div>




            <section id="chat" class="chat">
        <div id="messages" class="messages"></div>
        
        <div id="coachActionBar" class="coach-action-bar hidden">
          <img src="https://cdn-icons-png.flaticon.com/512/4712/4712027.png" alt="Coach" class="coach-avatar">
          <button id="showCoachTipButton" class="coach-analysis-button">대화 분석하기</button>
        </div>

        <div class="input">
        <input id="text" placeholder="메시지를 입력하세요..." onkeypress="if(event.key==='Enter'){sendMessage()}" />
        <button id="recordButton" title="음성으로 입력">🎤</button>
        <button id="sendButton" onclick="sendMessage()">전송</button>
        <button id="endChatButton" onclick="endChat()" title="면담 종료 후 요약 생성">면담종료</button>
        </div>


        <div id="recordStatus" style="text-align:right; font-size:12px; color:#e84118; height:15px; margin-top:5px;"></div>
        <div id="summary" class="summary"></div>
      </section>

    </div>
  </div>

  <div id="summaryModal" class="modal">
    <div class="modal-content">
      <h3>면담 결과 리포트</h3>
      <div class="evaluation-signal">
        <div id="trafficLight" class="traffic-light"></div>
        <div id="evaluationScore" class="evaluation-score"></div>
      </div>
      <div id="categoryBoard" class="category-board"></div>

      <div id="reportLoadingIndicator" style="text-align: center; padding: 20px;"></div>
      <div id="reportContainer" class="report-container" style="display: none;">
        <div class="report-block">
          <h4>🧐 면담 돌아보기</h4> <div id="reportBlock1" class="modal-summary-content"></div> <div id="reportBlock2" class="modal-summary-content" style="margin-top: 15px; border-top: 1px dashed #ccc; padding-top: 15px;"></div> </div>
      
        <div class="report-block">
          <h4>💡 면담 배워보기 (Tip & Skill)</h4>
          <div id="reportBlock3" class="modal-summary-content"></div>
        </div>
      </div>
      
      <div class="modal-actions">
        <button class="btn-download" onclick="downloadReportAsPDF()">결과 Report PDF 다운로드</button>
        <button class="btn-back" onclick="goToStart()">처음으로</button>
      </div>
    </div>
  </div>

    <div id="guidanceModal" class="modal">
    <div class="modal-content">
      <h3 id="guidanceTitle">📋 목표설정 면담 가이드</h3>
      <button id="guidanceCloseButton" class="modal-close-button">×</button>
      
      <div id="guidanceContentWrapper" class="modal-summary-content" style="background: #fff; line-height: 1.7;">
        <h4>1. 어떤 단계인가요?</h4>
        <p id="guidanceDefinition"></p>
        
        <h4>2. 무엇을 유의해야 할까요?</h4>
        <p id="guidanceConsiderations"></p>
        
        <h4>3. 면담 Tip & Skill</h4>
        <p id="guidanceTips"></p>
        
        <h4 style="margin-top: 20px; border-top: 1px dashed #ccc; padding-top: 20px;">⭐ 선택한 구성원 맞춤 Tip</h4>
        <p id="guidancePersona"></p>
      </div>
      
      <div class="modal-actions">
        <button id="guidanceStartButton" class="start-button">면담 시작하기</button>
      </div>
    </div>
  </div>


  <div id="coachTipModal" class="modal">
    <div class="modal-content">
      <h3><img src="https://cdn-icons-png.flaticon.com/512/4712/4712027.png" alt="Coach" style="width:30px; height:30px; border-radius:50%; vertical-align:middle; margin-right:10px;">성과관리 코치</h3>
      <button class="modal-close-button" onclick="hideCoachModal()">×</button>
      <div id="coachAnalysisContent" class="modal-summary-content" style="margin-top:15px; margin-bottom:20px; background:#f0f3f5;">
      </div>
      <div id="coachChoicesContainer" style="display:flex; flex-direction:column; gap:10px;">
      </div>
    </div>
  </div>



  </div>
  <script>
  // ===== GLOBAL STATE & CONSTANTS =====
    const AVATARS = { 
        low: 'https://cdn-icons-png.flaticon.com/512/4128/4128176.png', 
        mid: 'https://cdn-icons-png.flaticon.com/512/4128/4128335.png', 
        high: 'https://cdn-icons-png.flaticon.com/512/4128/4128253.png',  
        custom: 'https://cdn-icons-png.flaticon.com/512/3135/3135715.png' 
    };
    let currentStage = '', currentScenario = '', currentPersona = 'mid', currentMode = 'general', customPersonaData = null, history = [];
    let useCustomAvatar = false;
    let OBJECTION_TURNS = 0; // Defined here to prevent ReferenceError
    const elMessages = document.getElementById('messages');
    const elText = document.getElementById('text');
    const elSummary = document.getElementById('summary');

    // API KEY MANAGEMENT
    let GEMINI_API_KEY = 'AIzaSyAyuLp39374D5PnCk0gYYqAPCgZUFemny0'; 
    
    // Request API Key immediately from parent
    try {
        window.parent.postMessage({ type: 'REQUEST_API_KEY' }, '*');
    } catch(e) { console.log('Standalone mode'); }

    // Listen for API Key from parent window
    window.addEventListener('message', (event) => {
        if (event.data && event.data.type === 'SET_API_KEY') {
            GEMINI_API_KEY = event.data.key;
            console.log('API Key received securely.');
        }
    });

    // PDF Download Function Implementation
    window.downloadReportAsPDF = async function() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        
        const element = document.querySelector('.modal-content'); // Target the specific content
        if (!element) {
            alert("리포트 내용을 찾을 수 없습니다.");
            return;
        }

        // Hide buttons for capture
        const actions = element.querySelector('.modal-actions');
        if(actions) actions.style.display = 'none';

        try {
            const canvas = await html2canvas(element, { scale: 2, useCORS: true });
            const imgData = canvas.toDataURL('image/png');
            const imgProps = doc.getImageProperties(imgData);
            const pdfWidth = doc.internal.pageSize.getWidth();
            const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;
            
            doc.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);
            doc.save('면담_결과_리포트.pdf');
        } catch (err) {
            console.error("PDF generation failed", err);
            alert("PDF 다운로드 중 오류가 발생했습니다: " + err.message);
        } finally {
            if(actions) actions.style.display = 'flex';
        }
    };

  function cleanText(t){
     if (!t) return '';
    let s = t.replace(/\\n/g, '\n').replace(/\\r/g, '');
     // 문장 앞 라벨 제거(질문: / 조언: / Question: / Advice:)
    s = s.replace(/^\s*(질문|조언|Question|Advice)\s*[:：]\s*/i, '');
    s = s
      .replace(/\*\*(.*?)\*\*/g, '$1')   // **bold**
      .replace(/__(.*?)__/g, '$1')       // __bold__
      .replace(/_(.*?)_/g, '$1')         // _italic_
      .replace(/^\s*[•\-*]\s+/gm, '')    // bullets at line start
      .replace(/^\s*#{1,6}\s*/gm, '')    // # headers
      .replace(/`{1,3}[^`]*`{1,3}/g, '') // inline code/backticks
      .replace(/\|\|\s*CHOICE\s*[12]\s*\|\|/gi, ''); // stray markers
    // 기타
    s = s.replace(/\+\s?/g, '');
    s = s.replace(/\n{3,}/g, '\n\n');
    return s.trim();
 }

    function simplifyJargon(t){
      if (!t) return '';
      return t
        .replace(/recency\s*bias/ig, '최근 일만 보고 판단하지 않기')
        .replace(/leniency\s*bias/ig, '너무 관대하게 보지 않기')
        .replace(/strictness\s*bias/ig, '너무 엄격하게 보지 않기')
        .replace(/halo\s*effect/ig, '한 가지만 보고 전체 판단하지 않기')
        .replace(/attribution\s*bias/ig, '사람 탓만 하지 않기');
    }

    function normalizeChoice(s=''){
  s = simplifyJargon(s);
  // 1인칭 소유 제거
  s = s.replace(/\b(저희|우리)\s*(반|조|라인|팀)\b/g, '$2');
  // 딱딱한 보고체 완화
  s = s.replace(/설명해\s*주시겠습니까\??/g, '말씀해 주실까요?')
       .replace(/자세히\s*말씀해\s*주시겠습니까\??/g, '조금만 더 구체적으로 말씀해 주실까요?');
  // 이의제기 초반에 지표로 튀면 안전한 질문으로 교체
  if (currentScenario === 'objection' && /가동률|수율|불량률|납기|지표|수치|%/.test(s)) {
    s = '먼저 속상하셨겠어요, 어떤 점이 가장 억울했는지 한 가지만 말씀해 주실까요?';
  }
  return s.trim();
}

    // [수정] '면담 돌아보기' & '배워보기'를 위한 단순 마크다운 변환 함수
    function cleanReportMarkdown(text) {
    if (!text) return '';
    // 각 줄을 p 태그로 감싸서 일관된 간격을 유지하도록 합니다.
    return text.trim().split('\n').map(line => `<p>${line.replace(/-\s/,'• ')}</p>`).join('');
}

        // [수정] '면담 평가(A,B,C,D)' 전용 포맷 함수
        function formatEvaluationText(htmlText, categories) {
    if (!htmlText || !htmlText.trim()) {
        return '<p>평가 내용이 생성되지 않았습니다.</p>';
    }

    if (!categories || Object.keys(categories).length === 0) {
        return htmlText; // 색상 정보가 없으면 원본을 그대로 반환
    }

    const wrapper = document.createElement('div');
    wrapper.innerHTML = htmlText;

    wrapper.querySelectorAll('.evaluation-item').forEach(item => {
        const strongTag = item.querySelector('strong');
        if (!strongTag) return;

        const titleText = strongTag.textContent;
        // 제목에서 '관계형성', '과정관리' 등 카테고리 이름을 추출
        const categoryNameMatch = titleText.match(/[A-D]\.\s*([^(\s]+)/);
        if (categoryNameMatch && categoryNameMatch[1]) {
            const categoryName = categoryNameMatch[1];
            const categoryData = categories[categoryName];

            if (categoryData) {
                // 데이터 태그에서 가져온 정확한 색상으로 이모지 생성
                const colorEmoji = categoryData.light === 'green' ? '🟢' : 
                                   categoryData.light === 'yellow' ? '🟡' : '🔴';
                
                // 제목 텍스트에 이모지를 삽입하여 교체
                const scoreMatch = titleText.match(/\(.*\)/);
                const scoreText = scoreMatch ? scoreMatch[0] : ''; // "(60점)"
                strongTag.innerHTML = `${categoryName} (${colorEmoji}, ${scoreText.slice(1)}`;
            }
        }
    });

    return wrapper.innerHTML;
}


// 문장 블록 줄바꿈 유틸 (전역)
function setBubbleText(bubble, text, sentencesPerLine = 2) {
  if (!bubble) return;
  let s = String(text ?? '')
    .replace(/\r\n?/g, ' ')
    .replace(/<br\s*\/?>/gi, ' ')
    .replace(/\s+/g, ' ')
    .trim();

  const sentenceRegex = /.*?(?:…|[!?]|(?<!\d)\.(?!\d))/g; // 소수점(.)는 제외
  let sentences = s.match(sentenceRegex) || [];
  const consumed = sentences.join('').length;
  if (consumed < s.length) sentences.push(s.slice(consumed));

  sentences = sentences.map(v => v.trim()).filter(Boolean);
  if (sentences.length === 0) sentences = [s];

  const lines = [];
  for (let i = 0; i < sentences.length; i += sentencesPerLine) {
    lines.push(sentences.slice(i, i + sentencesPerLine).join(' '));
  }

  bubble.textContent = '';
  lines.forEach((line, idx) => {
    bubble.appendChild(document.createTextNode(line));
    if (idx < lines.length - 1) bubble.appendChild(document.createElement('br'));
  });
}

    // ===== CHAT UI HELPERS =====
    function appendMessage(role, text) {
      text = simplifyJargon(cleanText(text));
      const row = document.createElement('div');
      row.className = `row ${role}`;
      
      if (role === 'model') {
        const avatarDiv = document.createElement('div'); avatarDiv.className = 'avatar';
        const avatarImg = document.createElement('img'); avatarImg.src = getAvatarSrc(); avatarImg.alt = 'avatar';
        avatarDiv.appendChild(avatarImg);

        // Correctly handle OBJECTION_TURNS
        if (typeof currentScenario !== 'undefined' && currentScenario === 'objection' && role === 'model') {
            OBJECTION_TURNS++;
        }

        const bubble = document.createElement('div'); bubble.className = 'bubble bot'; setBubbleText(bubble, text);
        row.appendChild(avatarDiv); row.appendChild(bubble);
        elMessages.appendChild(row);
        const name = document.createElement('div'); name.className = 'name';
        if (currentMode === 'advanced' && customPersonaData && customPersonaData.name) { name.textContent = customPersonaData.name; }
        else { name.textContent = personas[currentPersona].name; }
        elMessages.appendChild(name);
      } else {
        const bubble = document.createElement('div'); bubble.className = 'bubble user'; setBubbleText(bubble, text);
        row.appendChild(bubble); elMessages.appendChild(row);
      }
      elMessages.scrollTop = elMessages.scrollHeight;
    }

    // 사용자가 "자료 보고 얘기하자/없다/나중에" 등을 말하면 스킵 의도 처리
    const SKIP_RE = /(자료|기록|근무표|명세서|지표|수치).{0,12}(없|못|나중|이후|보면서|보고)|스킵|건너뛰|지금은\s*어려|패스/i;

    function preprocessUserText(raw='') {
      const s = String(raw).trim();
      if (SKIP_RE.test(s)) {
        // 모델에게 내부 지침으로 전달(사용자 메시지는 그대로 보여도됨)
        return s + "\n[대화방향] 지금은 자료/기록 없이 진행. 기억·관찰 기반 대표 상황 1개만 요청하고, " +
                    "선택지로 (A) 자료 확인 후 재면담(담당·기한) (B) 지금 들은 내용 기준 임시 결론 요약 후 계장/HR 제안 을 제공.";
      }
      return s;
    }

    
    function appendTypingIndicator() {
      if (document.getElementById('typingRow')) return;
      const row = document.createElement('div'); row.id = 'typingRow'; row.className = 'row bot';
      const avatarDiv = document.createElement('div'); avatarDiv.className = 'avatar';
      const avatarImg = document.createElement('img'); avatarImg.src = getAvatarSrc(); avatarImg.alt = 'typing';
      avatarDiv.appendChild(avatarImg);
      const typing = document.createElement('div'); typing.className = 'typing'; typing.innerHTML = '<span class="dots"><span></span><span></span><span></span></span>';
      row.appendChild(avatarDiv); row.appendChild(typing); elMessages.appendChild(row);
      elMessages.scrollTop = elMessages.scrollHeight;
    }
    function hideTyping() { const t = document.getElementById('typingRow'); if (t) t.remove(); }

    // ===== COACH MODAL =====
    let coachTipModal;
    function showCoachModal() {
      if (!coachTipModal) coachTipModal = document.getElementById('coachTipModal');
      coachTipModal.style.display = 'flex';
    }
    function hideCoachModal() {
      if (!coachTipModal) coachTipModal = document.getElementById('coachTipModal');
      coachTipModal.style.display = 'none';
    }
    function displayCoachingTip(rawTip) {
    // CHOICE 구분자를 공백/대소문자 허용하여 분리
    const parts = rawTip.split(/\|\|\s*CHOICE1\s*\|\||\|\|\s*CHOICE2\s*\|\|/i);
     let analysis = simplifyJargon(cleanText(parts[0] || ''));
   // 잔여 토큰/라벨/질문 제거 및 2문장 제한
  analysis = analysis
    .replace(/^\s*CHOICE\s*[12]\s*[:：].*$/gim, '')
    .replace(/\|\|\s*CHOICE\s*[12]\s*\|\|/gi, '')
    .replace(/\b(보상|급여|수당|야간수당)\b/gi, '')
    .replace(/\|\|(?!CHOICE1\|\||CHOICE2\|\|)[^|]{1,24}\|\|/g, '')
    .replace(/^\s*(분석|제안|질문|조언)\s*[:：]\s*/gim, '')
    .split(/(?<=[.。!！?？])\s+/).filter(s => s && !/[?？]/.test(s)).slice(0, 2).join(' ');

  const choice1 = normalizeChoice(cleanText(parts[1] || '질문을 하나만 더 여쭤볼까요?'));
  const choice2 = normalizeChoice(cleanText(parts[2] || '오늘 가능한 한 가지부터 시작해보시죠.'));

  const analysisEl = document.getElementById('coachAnalysisContent');
  const choicesEl = document.getElementById('coachChoicesContainer');
  analysisEl.textContent = analysis;
  choicesEl.innerHTML = '';

  const mk = (t) => { const b = document.createElement('button'); b.className='coach-choice-button'; b.textContent=t; b.onclick=()=>{ sendChoice(t); hideCoachModal(); }; return b; };
  choicesEl.appendChild(mk(choice1));
  choicesEl.appendChild(mk(choice2));

  const free = document.createElement('button');
  free.className='coach-choice-button'; free.textContent='💬 직접 입력하기';
  free.style.backgroundColor='#f0f3f5'; free.style.color='#333'; free.style.borderColor='#ccc';
  free.onclick=()=>{ hideCoachModal(); };
  choicesEl.appendChild(free);

  showCoachModal();
}

    function showCoachAnalysisFromButton() {
  let lastBot = null;
  for (let i = history.length - 1; i >= 0; i--) {
    const h = history[i];
    if (h.role === 'model' && h.parts?.[0]?.text && h.parts[0].text.includes('||COACH||')) {
      lastBot = h;
      break;
    }
  }
  if (!lastBot) { alert('아직 분석할 구성원의 대화가 없습니다.'); return; }
  const coachingTipRaw = lastBot.parts[0].text.split('||COACH||')[1] || '';
  displayCoachingTip(coachingTipRaw);
}
    function sendChoice(choiceText) {
      appendMessage('user', choiceText);
      history.push({ role: 'user', parts: [{ text: choiceText }] });
      const choices = document.querySelectorAll('.coach-choice-button');
      choices.forEach(c => { c.onclick = null; c.classList.add('disabled'); });
      getAIResponse(); // AI 응답을 직접 요청
    }

    function startChat(stage, scenario, persona) {
      currentStage = stage; 
      currentScenario = scenario; 
      currentPersona = persona;
      elMessages.innerHTML = ''; 
      elText.disabled = false;
      document.getElementById('sendButton').disabled = false;
      document.getElementById('endChatButton').disabled = false;
      document.getElementById('coachActionBar').classList.add('hidden');
      showScreen('chat');
      const systemPrompt = buildCombinedPrompt();
      history = [{ role: 'user', parts: [{ text: systemPrompt }] }];
      sendMessage(true); // isInitial 플래그로 첫 대화 시작
    }

        // ===== [NEW] GUIDANCE MODAL =====
    let guidanceModal;
    function showGuidanceModal() {
      if (!guidanceModal) guidanceModal = document.getElementById('guidanceModal');
      guidanceModal.style.display = 'flex';
    }
    function hideGuidanceModal() {
      if (!guidanceModal) guidanceModal = document.getElementById('guidanceModal');
      guidanceModal.style.display = 'none';
    }

    const guidanceContent = {
        goal: {
            title: "📋 목표설정 면담 가이드",
            definition: "구성원과 함께 한 해의 업무 목표를 설정하고 합의하는 초기 단계입니다. 명확하고 도전적인 목표를 설정하여 구성원에게 동기를 부여하는 것이 중요합니다.",
            considerations: "회사의 방향성과 구성원의 성장 계획이 모두 연계될 수 있도록 목표를 조율해야 합니다. 일방적인 지시가 아닌, 구성원의 의견을 충분히 듣고 합의하는 과정이 필수적입니다.",
            tips: "• 목표는 SMART(Specific, Measurable, Achievable, Relevant, Time-bound) 원칙에 따라 구체적으로 설정하세요.\n• 구성원이 스스로 목표를 제안하도록 유도하여 주인의식을 높여주세요."
        },
        feedback: {
            title: "💬 중간피드백 면담 가이드",
            definition: "설정된 목표에 대해 중간 과정을 점검하고, 잘하고 있는 점과 개선이 필요한 부분에 대해 피드백을 주고받는 단계입니다.",
            considerations: "비판이 아닌 성장을 위한 코칭 관점에서 접근해야 합니다. 잘한 점을 먼저 인정하고 격려하여 긍정적인 분위기를 조성하는 것이 중요합니다.",
            tips: "• 'S-B-I (Situation-Behavior-Impact)' 모델을 활용하여 구체적이고 사실 기반의 피드백을 전달하세요.\n• 해결책을 직접 제시하기보다, '어떻게 하면 더 좋을까요?'와 같이 구성원 스스로 답을 찾도록 질문하세요."
        },
        before: {
            title: "📊 최종평가 (평가 전) 면담 가이드",
            definition: "공식적인 최종평가 결과가 나오기 전, 한 해의 성과에 대해 미리 의견을 나누고 기대 수준을 정렬하는 단계입니다.",
            considerations: "평가자가 놓치고 있는 성과나 어려움이 있었는지 최종적으로 확인하는 기회입니다. 평가 결과에 대한 예측보다는 과정에 대한 리뷰에 집중해야 합니다.",
            tips: "• 구성원이 스스로의 성과를 먼저 이야기하도록 하는 '자기평가' 기회를 먼저 부여하세요.\n• 예상되는 평가 등급을 미리 암시하지 않도록 주의하세요."
        },
        appeal: {
            title: "🙋‍♂️ 이의제기 면담 가이드",
            definition: "구성원이 평가 결과에 동의하지 못하고 이의를 제기했을 때, 이를 해결하기 위해 진행하는 면담입니다.",
            considerations: "구성원의 의견을 '방어'나 '변명'으로 치부하지 말고, 객관적인 근거와 논리를 바탕으로 경청하는 자세가 매우 중요합니다. 감정적인 대응은 피해야 합니다.",
            tips: "• 먼저 구성원의 입장을 충분히 들어주며 감정을 해소할 기회를 주세요.\n• 논의의 초점을 '평가 등급 변경'이 아닌 '평가 근거에 대한 상호 이해'에 맞추세요."
        }
    };

    const personaGuidance = {
        low: "선택한 구성원은 [저성과자]입니다. 자신감이 낮을 수 있으니, 질책보다는 격려와 함께 작고 구체적인 성공 경험을 만들 수 있는 목표를 제안하는 것이 효과적입니다.",
        mid: "선택한 구성원은 [중간성과자]입니다. 강점과 약점에 대해 균형 잡힌 시각을 가지고 있으므로, 스스로 개선점을 찾고 계획을 세우도록 코칭 질문을 활용하는 것이 좋습니다.",
        high: "선택한 구성원은 [고성과자]입니다. 이미 높은 수준의 성과를 내고 있으므로, 더 도전적인 목표나 새로운 역할(리더십, 멘토링 등)을 제안하여 성장 동기를 자극하는 것이 중요합니다.",
        custom: "직접 설정한 [맞춤 성격]의 특성을 고려하여, 해당 구성원의 강점을 최대한 활용하고 약점을 보완할 수 있는 방향으로 면담을 이끌어 보세요."
    };

    function showGuidancePopup(contentKey, stage, subScenario = '') {
      const content = guidanceContent[contentKey];
      const personaContent = personaGuidance[currentPersona] || "선택한 구성원의 특성을 고려하여 면담을 진행하세요.";

      // 팝업 내용 채우기
      document.getElementById('guidanceTitle').innerText = content.title;
      document.getElementById('guidanceDefinition').innerText = content.definition;
      document.getElementById('guidanceConsiderations').innerText = content.considerations;
      document.getElementById('guidanceTips').innerText = content.tips;
      document.getElementById('guidancePersona').innerText = personaContent;

      // 닫기 및 시작 버튼에 채팅 시작 기능 연결
      const startButton = document.getElementById('guidanceStartButton');
      const closeButton = document.getElementById('guidanceCloseButton');
      
      const startAction = () => {
          hideGuidanceModal();
          startChat(stage, subScenario, currentPersona);
      };
      
      startButton.onclick = startAction;
      closeButton.onclick = startAction;

      showGuidanceModal();
    }


    // ===== GEMINI API & CHAT LOGIC =====
    // getAIResponse moved to earlier part of script to be accessible.

        // [새로운 함수] AI 답변 요청을 전담하는 함수
    async function getAIResponse() {
      const sendButton = document.getElementById('sendButton');
      const coachActionBar = document.getElementById('coachActionBar');
      
      if (!GEMINI_API_KEY) {
          appendErrorMessage('API 키가 설정되지 않았습니다. 잠시 후 다시 시도해주세요.');
          // Retry requesting key
          window.parent.postMessage({ type: 'REQUEST_API_KEY' }, '*');
          return;
      }

      const GEMINI_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${GEMINI_API_KEY}`;

      elText.disabled = true;
      sendButton.disabled = true;
      document.getElementById('endChatButton').disabled = true;
      if(coachActionBar) coachActionBar.classList.add('hidden');
      
      appendTypingIndicator(); // 타이핑 인디케이터 표시

      try {
        const res = await fetch(GEMINI_API_URL, {
          method: 'POST', headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            contents: history,
            generationConfig: { temperature: 0.8, maxOutputTokens: 1024 }
          })
        });
        if (!res.ok) { // API 응답이 성공(200 OK)이 아닐 경우
          const errorData = await res.json();
          throw new Error(errorData.error?.message || ('API 요청 실패: ' + res.status));
        }
        const data = await res.json();

        hideTyping(); // 타이핑 인디케이터 숨기기

        if (data.candidates?.[0] && data.candidates[0].content.parts?.[0]?.text) {
          const rawResponse = data.candidates[0].content.parts[0].text;
const [memberResponse] = rawResponse.split('||COACH||');
appendMessage('model', cleanText(memberResponse));
history.push({ role: 'model', parts: [{ text: rawResponse }] });

if (coachActionBar) {
  const hasCoach = rawResponse.includes('||COACH||');
  coachActionBar.classList.toggle('hidden', !hasCoach);
  document.getElementById('showCoachTipButton').onclick = showCoachAnalysisFromButton;
}

        } else { // 응답 내용이 없거나 형식이 올바르지 않을 경우
          // [수정된 부분]: 오류 아바타와 경고 메시지 표시
          appendErrorMessage('죄송합니다. 답변을 생성하지 못했습니다. 다시 시도해 주시겠어요?');
        }
      } catch (e) { // API 호출 자체에서 오류가 발생했을 경우 (네트워크 오류 등)
        hideTyping(); // 타이핑 인디케이터 숨기기
        console.error('API Error:', e);
        // [수정된 부분]: 오류 아바타와 에러 메시지 표시
        appendErrorMessage('API 호출 중 오류가 발생했습니다: ' + e.message + ' 잠시 후 다시 시도해주세요.');
      } finally {
        elText.disabled = false;
        sendButton.disabled = false;
        document.getElementById('endChatButton').disabled = false;
        elText.focus();
      }
    }

    // [새로 추가된 함수]: 오류 메시지를 특정 아바타로 표시
    function appendErrorMessage(message) {
      const row = document.createElement('div');
      row.className = `row bot error`; // 'error' 클래스를 추가하여 스타일을 다르게 할 수도 있습니다.
      const avatarDiv = document.createElement('div'); avatarDiv.className = 'avatar';
      const avatarImg = document.createElement('img'); avatarImg.src = 'https://cdn-icons-png.flaticon.com/512/463/463612.png'; avatarImg.alt = 'error_avatar';
      // Fallback for error avatar if local file is missing
      avatarImg.onerror = function() { this.src = 'https://placehold.co/55x55/fecaca/b91c1c?text=!'; };
      
      avatarDiv.appendChild(avatarImg);
      const bubble = document.createElement('div'); bubble.className = 'bubble bot'; // 기본 봇 버블 스타일 사용
      bubble.style.backgroundColor = '#fce4ec'; // 배경색을 붉은 계열로 변경하여 경고 강조
      bubble.style.borderColor = '#ef9a9a';
      bubble.style.color = '#c62828'; // 텍스트 색상 변경
      bubble.textContent = message;
      row.appendChild(avatarDiv); row.appendChild(bubble);
      elMessages.appendChild(row);
      
      const name = document.createElement('div'); name.className = 'name';
      name.textContent = '시스템 알림'; // 오류 메시지일 때는 '시스템 알림'으로 표시
      elMessages.appendChild(name);

      elMessages.scrollTop = elMessages.scrollHeight;
    }



    // 기존의 sendMessage 함수를 지우고 아래 코드로 교체해주세요.
    async function sendMessage(isInitial = false) {
  if (isInitial) {
    // 대화 시작 시 첫 메시지를 요청
    history.push({ role: 'user', parts: [{ text: "이제 면담을 시작하겠습니다. 구성원으로서 저에게 첫마디를 해주세요." }] });
  } else {
    // 사용자가 입력한 메시지 처리
    let userText = elText.value.trim(); // 'input'을 'elText'로 수정한 최종 버전입니다.
    userText = preprocessUserText(userText);
    if (!userText) return; // 입력이 없으면 종료
    appendMessage('user', userText);
    history.push({ role: 'user', parts: [{ text: userText }] });
    elText.value = '';
  }
  
  await getAIResponse(); // AI 응답 요청
}

    
    function startChat(stage, scenario, persona) {
      currentStage = stage; 
      currentScenario = scenario; 
      currentPersona = persona;
      elMessages.innerHTML = ''; 
      elText.disabled = false;
      document.getElementById('sendButton').disabled = false;
      document.getElementById('endChatButton').disabled = false;
      document.getElementById('coachActionBar').classList.add('hidden');
      showScreen('chat');
      const systemPrompt = buildCombinedPrompt();
      history = [{ role: 'user', parts: [{ text: systemPrompt + "\\n\\n이제 면담을 시작하겠습니다. 구성원으로서 저에게 첫마디를 해주세요." }] }];
      sendMessage(true);
    }
    
    // ===== SUMMARY MODAL & END CHAT =====
    let summaryModal, modalSummaryContent;
    function renderCategoryBoard(cats){
      const board = document.getElementById('categoryBoard');
      if (!board) return;
      board.innerHTML = '';
      cats.forEach(c => {
        const item = document.createElement('div'); item.className = 'cat';
        const tl = document.createElement('div'); tl.className = 'traffic-light ' + c.light;
        const label = document.createElement('div'); label.className = 'label'; label.textContent = c.name;
        const score = document.createElement('div'); score.className = 'score'; score.textContent = c.score + '점';
        item.appendChild(tl); item.appendChild(label); item.appendChild(score);
        board.appendChild(item);
      });
    }
    function showModal() {
      if (!summaryModal) summaryModal = document.getElementById('summaryModal');
      if (!modalSummaryContent) modalSummaryContent = document.getElementById('modalSummaryContent');
        summaryModal.style.display = 'flex';
       }
    function hideModal() { 
        if (!summaryModal) summaryModal = document.getElementById('summaryModal');  
        summaryModal.style.display = 'none'; 
    }
    function downloadSummary() {
      const text = modalSummaryContent.innerText;
      const blob = new Blob([text], { type: 'text/plain;charset=utf-8' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob); a.download = '면담결과_요약.txt'; a.click(); URL.revokeObjectURL(a.href);
    }
    function emailSummary() {
      const text = modalSummaryContent.innerText;
      const subject = encodeURIComponent('성과관리 면담 결과 요약');
      const body = encodeURIComponent('안녕하세요.\\n\\n면담 결과 요약을 공유드립니다.\\n\\n---\\n\\n' + text);
      window.location.href = `mailto:?subject=${subject}&body=${body}`;
    }


    async function endChat() {
    // 1. 필요한 모든 UI 요소를 변수로 지정합니다.
    const loadingIndicator = document.getElementById('reportLoadingIndicator');
    const reportContainer = document.getElementById('reportContainer');
    const signalArea = document.querySelector('.evaluation-signal');
    const categoryBoard = document.getElementById('categoryBoard');
    const actionButtons = document.querySelector('.modal-actions');

    // 2. 리포트 영역을 제외한 모든 UI를 숨기고 로딩 메시지만 표시합니다.
    if(signalArea) signalArea.style.display = 'none';
    if(categoryBoard) categoryBoard.style.display = 'none';
    if(actionButtons) actionButtons.style.display = 'none';
    if(reportContainer) reportContainer.style.display = 'none';
    
    loadingIndicator.style.display = 'block';
    loadingIndicator.innerHTML = '<b>⏳ AI 성과관리 전문가가 면담 내용을 분석하고 있습니다...</b>';
    
    showModal();
    
    const transcript = history.slice(1).map(turn => {
    return `${turn.role === 'user' ? '리더' : '구성원'}: ${turn.parts[0].text.split('||COACH||')[0].trim()}`;
    }).join('\n');

    const learnMoreDescriptions = {
  goal: `
    <b>목표설정 면담</b>에서는 GROW 모델의 출발점인 <b>Goal</b> 단계가 핵심입니다. 
    구성원이 스스로 달성하고자 하는 목표를 명확하게 정의하도록 돕고, 
    목표가 <u>구체적이고(Specific), 측정 가능하며(Measurable), 현실적이고(Realistic), 기한이 있는(Time-bound)</u>지 점검해야 합니다. 
    또한 <b>Reality</b> 단계에서는 현재 상황을 객관적으로 진단하여 목표 달성에 필요한 역량과 자원을 확인하고, 
    과거 성과나 장애요인도 함께 검토하는 것이 중요합니다.
  `,
  feedback: `
    <b>중간피드백 면담</b>에서는 <b>Reality</b> 단계에서 현재 진행 상황과 성과를 구체적으로 점검해야 합니다. 
    단순히 결과만 확인하는 것이 아니라, 구성원이 체감하는 어려움과 장애요인을 깊이 있게 듣는 것이 중요합니다. 
    이어서 <b>Options</b> 단계에서는 리더와 구성원이 함께 다양한 해결 방안을 탐색하고, 
    단기·중기적 대안들을 나열한 뒤 우선순위를 정하는 방식으로 방향성을 잡을 수 있습니다. 
    이 과정에서 리더는 지시보다는 <u>질문과 코칭</u>을 통해 스스로 선택지를 찾도록 지원하는 것이 핵심입니다.
  `,
  evaluation: `
    <b>최종평가 면담</b>에서는 지난 한 해의 성과(<b>Reality</b>)를 돌아보고, 
    단순한 결과 비교가 아니라 목표 달성 과정에서 나타난 <u>노력, 성취, 성장</u>을 균형 있게 평가해야 합니다. 
    그다음 <b>Will</b> 단계로 이어져, 평가 결과를 토대로 구성원이 스스로 <u>다음 성장을 위한 실행 의지와 구체적 실행계획</u>을 수립할 수 있도록 돕는 것이 중요합니다. 
    특히, 긍정적인 피드백과 향후 발전 방향을 함께 제시해 <u>동기부여</u>를 높이는 것이 효과적입니다.
  `,
  objection: `
    <b>이의제기 면담</b>은 GROW 모델을 보완적으로 활용할 수 있습니다. 
    <b>Reality</b> 단계에서는 구성원이 느낀 불합리하거나 납득하기 어려운 평가 근거를 충분히 경청하고, 
    구체적인 사례와 데이터를 바탕으로 사실 관계를 명확히 해야 합니다. 
    이어서 <b>Options</b> 단계에서는 문제 해결을 위한 대안을 함께 모색할 수 있는데, 이는 평가 재검토뿐만 아니라 향후 개선을 위한 협의까지 포함됩니다. 
    마지막으로 <b>Will</b> 단계에서는 향후 유사한 갈등을 방지할 수 있는 합의점을 찾고, 
    조직과 구성원이 함께 신뢰를 회복할 수 있도록 마무리하는 것이 필요합니다.
  `
};
    const learnMoreDescription = learnMoreDescriptions[currentStage] || '<p>효과적인 성과관리 면담은 GROW 모델에 기반하여 진행할 수 있습니다.</p>';

    const personaName = (currentMode === 'advanced' && customPersonaData?.name) ? customPersonaData.name : personas[currentPersona].name;

    const evaluationPrompt = `
당신은 세계 최고의 성과관리 전문가입니다. 주어진 면담 대화록을 분석하여 리더의 성장을 돕기 위한 3단계 리포트를 생성해주세요.
**결과는 반드시 아래의 [결과 출력 형식]을 정확히 따라서, 구분자(||BLOCK_SEPARATOR||)를 포함하여 생성해야 합니다.**

[면담 정보]
- 면담 종류: ${currentStage} (${currentScenario||'일반'})
- 구성원: ${personaName}

[대화록]
${transcript}
---
[가장 중요한 지시사항: 리포트 형식 준수]
- 당신의 다른 모든 임무보다, 지금부터 설명할 **[평가 기준]과 [결과 출력 형식]을 지키는 것이 가장 중요**합니다.
- 리포트 내용이 조금 부정확해지더라도, **출력 형식(특히 '[CAT:...]' 태그 4개와 '||BLOCK_SEPARATOR||' 구분자)은 완벽해야 합니다.**
- 만약 대화 내용이 너무 복잡하여 모든 규칙을 지키기 어렵다고 판단되면, 다른 모든 것을 희생하더라도 **'[CAT:...]' 태그 4개를 정확히 출력하는 것을 최우선 목표**로 삼으세요. 이 태그 생성이 실패하면 리포트 전체가 실패합니다.

[평가 기준]
당신은 아래 4가지 영역에 대해 주어진 기준에 따라 면담을 평가하고, 각 영역의 신호등 색상과 0~100점 사이의 점수를 부여해야 합니다.

A. 관계형성(신뢰·심리적 안전)
- 정의: 공감, 경청, 요약, 감정 라벨링을 통해 대화 안전지대를 만드는 능력.
- 기준: 🟢 (근거 3개 이상 + 요약·반영 2회 이상), 🟡 (근거 1~2개 또는 일관성 부족), 🔴 (공감 결여, 단정·명령형 다수)

B. 과정관리(문제정의·원인·계획)
- 정의: 사실 확인→원인 가설→대안→우선순위→실행계획으로 이어지는 구조화.
- 기준: 🟢 (데이터 근거 + 실행계획 명확), 🟡 (일부 누락), 🔴 (구조 없음)

C. 성과창출(결과·임팩트)
- 정의: 목표와 연계된 결과 지향과 책임감.
- 기준: 🟢 (KPI 연계 + 점검 주기 합의), 🟡 (KPI 언급만 있고 후속 미흡), 🔴 (목표 불명확, 책임 회피)

D. 성장지원(코칭·피드백·학습)
- 정의: 코칭 질문, 강점 피드백, 리소스 연결, 학습·리허설 지원.
- 기준: 🟢 (코칭 대화 + 성장 행동 약속), 🟡 (조언만 있고 실험 부재), 🔴 (지적 중심, 낙인 표현)

---
[결과 출력 형식]
[EVALUATION: SCORE=<종합점수는 JS에서 계산하므로 0으로 고정>, LIGHT=<종합신호등은 JS에서 계산하므로 중립적으로 고정>]
[CAT:관계형성=<산출한 색상>,<산출한 점수>]
[CAT:과정관리=<산출한 색상>,<산출한 점수>]
[CAT:성과창출=<산출한 색상>,<산출한 점수>]
[CAT:성장지원=<산출한 색상>,<산출한 점수>]

첫 번째 블록에는 '[면담 돌아보기]' 내용을 생성합니다. 먼저 면담 전체 상황에 대한 요약 문단을 생성한 뒤, '주요 관찰 포인트'와 '개선 제안'을 각각의 HTML 카드로 만들어주세요.
[면담의 전체적인 상황과 결과를 2~3문장으로 요약]

<div class="tip-card-container">
  <div class="tip-card">
    <h5>📝 주요 관찰 포인트</h5>
    <ul>
      <li>[리더의 행동이나 구성원의 반응 등 객관적 사실 1]</li>
      <li>[객관적 사실 2]</li>
    </ul>
  </div>
  <div class="tip-card">
    <h5>💡 개선 제안</h5>
    <ul>
      <li>[아쉬웠던 점을 보완할 구체적인 행동 방안이나 질문 예시 1]</li>
      <li>[행동 방안 2]</li>
    </ul>
  </div>
</div>
||BLOCK_SEPARATOR||
두 번째 블록에는 '[면담 평가]' 내용을 아래의 HTML 형식에 맞춰 생성합니다.

<div class="evaluation-item">
  <strong>A. 관계형성 ([산출한 이모지], [산출한 점수]점):</strong>
  <p class="evaluation-description">[A 항목에 대한 내용 서술]</p>
</div>
<div class="evaluation-item">
  <strong>B. 과정관리 ([산출한 이모지], [산출한 점수]점):</strong>
  <p class="evaluation-description">[B 항목에 대한 내용 서술]</p>
</div>
<div class="evaluation-item">
  <strong>C. 성과창출 ([산출한 이모지], [산출한 점수]점):</strong>
  <p class="evaluation-description">[C 항목에 대한 내용 서술]</p>
</div>
<div class="evaluation-item">
  <strong>D. 성장지원 ([산출한 이모지], [산출한 점수]점):</strong>
  <p class="evaluation-description">[D 항목에 대한 내용 서술]</p>
</div>

||BLOCK_SEPARATOR||
세 번째 블록에는 '[면담 배워보기 (Tip & Skill)]' 내용을 생성합니다. 먼저 아래에 제공된 설명을 최상단에 포함한 뒤, 4가지 핵심 역량에 대한 팁을 HTML 카드 형식으로 생성해주세요.

${learnMoreDescription}

아래 4가지 핵심 역량에 대한 팁을 HTML 카드 형식으로 생성해주세요.
각 역량별로 2개의 실행 가능한 팁을 불릿 포인트(-)로 생성합니다. 각 역량의 제목에는 연관된 이모지를 포함해주세요.
<div class="tip-card-container">
<div class="tip-card">
<h5>🤝 관계 형성 (Rapport)</h5>
<ul>
- (실행 팁 1)
- (실행 팁 2)
</ul>
</div>
<div class="tip-card">
<h5>🎯 성과 관리 (Performance)</h5>
<ul>
- (실행 팁 1)
- (실행 팁 2)
</ul>
</div>
<div class="tip-card">
<h5>💡 코칭 스킬 (Coaching)</h5>
<ul>
- (실행 팁 1)
- (실행 팁 2)
</ul>
</div>
<div class="tip-card">
<h5>🌱 성장 지원 (Development)</h5>
<ul>
- (실행 팁 1)
- (실행 팁 2)
</ul>
</div>
</div>

**매우 중요: 각 블록에는 '##'와 같은 마크다운 제목이나 대괄호 제목을 절대 포함하지 마세요. 오직 본문 내용만 작성해야 합니다.**
`;

try {
    const res = await fetch(GEMINI_API_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            contents: [{ role: 'user', parts: [{ text: evaluationPrompt }] }],
            generationConfig: { temperature: 0.7, maxOutputTokens: 4096 }
        })
    });
    if (!res.ok) throw new Error(`API Error: ${res.status}`);
    
    const data = await res.json();
    const evaluationText = data.candidates[0].content.parts[0].text;
    // 1. 면담 단계별 가중치 정의
    const weights = {
        goal: { '관계형성': 0.20, '과정관리': 0.40, '성과창출': 0.10, '성장지원': 0.30 },
        feedback: { '관계형성': 0.20, '과정관리': 0.35, '성과창출': 0.20, '성장지원': 0.25 },
        evaluation: { '관계형성': 0.15, '과정관리': 0.25, '성과창출': 0.40, '성장지원': 0.20 }
    };
    const currentWeights = weights[currentStage] || weights['feedback']; // 기본값은 중간피드백

    // 2. AI가 평가한 카테고리별 점수와 신호등 파싱
    const categories = {};
    let hasRedSignal = false;
    const regex = /\[CAT:([^=]+)=([^,]+),(\d+)\]/g;
    let match;
    while ((match = regex.exec(evaluationText)) !== null) {
        const name = match[1].trim();
        const lightKR = match[2].trim();
        const score = parseInt(match[3], 10);
        const light = lightKR.startsWith('녹') ? 'green' : (lightKR.startsWith('황') ? 'yellow' : 'red');
        
        categories[name] = { score, light };
        if (light === 'red') {
            hasRedSignal = true;
        }
    }

    // 3. 가중치를 적용하여 종합 점수 계산
    let totalScore = 0;
    for (const name in categories) {
        if (currentWeights[name]) {
            totalScore += categories[name].score * currentWeights[name];
        }
    }
    totalScore = Math.round(totalScore);

    // 4. 종합 신호등 결정 (안전장치 적용)
    let finalLight = 'green';
    if (totalScore < 80) finalLight = 'yellow';
    if (totalScore < 60) finalLight = 'red';
    if (hasRedSignal && finalLight === 'green') {
        finalLight = 'yellow'; // 안전장치: 빨간 신호가 하나라도 있으면 종합은 최대 노란색
    }

    // 5. 계산된 최종 점수와 신호등을 UI에 반영
    const trafficLight = document.getElementById('trafficLight');
    const evaluationScore = document.getElementById('evaluationScore');

    if (trafficLight && evaluationScore) {
      evaluationScore.textContent = `종합 점수: ${totalScore}점`;
     trafficLight.className = 'traffic-light'; // 초기화
     trafficLight.classList.add(finalLight);
    }
    // 카테고리 보드 렌더링
    const catsToRender = Object.keys(categories).map(name => ({
        name: name,
        light: categories[name].light,
        score: categories[name].score
    }));
    renderCategoryBoard(catsToRender);
    
    // --- [새로운 점수 계산 로직 끝] ---

    // 3단 블록으로 내용 분리 및 표시 (기존과 동일)
    const contentOnly = evaluationText.replace(/\[(EVALUATION|CAT):[^\]]+\]/g, '').trim();
    const blocks = contentOnly.split('||BLOCK_SEPARATOR||');
    
// endChat() 마지막의 렌더 부분 수정
document.getElementById('reportBlock1').innerHTML = blocks[0] || '내용 없음';
document.getElementById('reportBlock2').innerHTML = blocks[1] || '내용 없음';
document.getElementById('reportBlock3').innerHTML = blocks[2] || '<p>학습 내용을 불러오지 못했습니다.</p>';

} catch (e) {
    console.error('EndChat Error:', e);
    document.getElementById('reportBlock1').textContent = '리포트 생성 중 오류: ' + e.message;
} finally {
    // 로딩 끝나면 UI 요소들 다시 표시
    loadingIndicator.style.display = 'none';
    if(signalArea) signalArea.style.display = 'flex';
    if(categoryBoard) categoryBoard.style.display = 'grid';
    if(actionButtons) actionButtons.style.display = 'flex';
    if(reportContainer) reportContainer.style.display = 'flex';
}
    }

// 내보내기용 텍스트 빌더 추가
function getReportPlainText() {
  const t = [
    '## 1. 면담 돌아보기', document.getElementById('reportBlock1').innerText.trim(),
    '## 2. 면담 평가',     document.getElementById('reportBlock2').innerText.trim(),
    '## 3. 면담 배워보기', document.getElementById('reportBlock3').innerText.trim()
  ].join('\n\n');
  return t.replace(/\n{3,}/g, '\n\n').trim();
}

// 교체: downloadSummary() / emailSummary()
function downloadSummary() {
  const text = getReportPlainText();
  const blob = new Blob([text], { type: 'text/plain;charset=utf-8' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob); a.download = '면담결과_요약.txt'; a.click(); URL.revokeObjectURL(a.href);
}
function emailSummary() {
  const text = getReportPlainText();
  const subject = encodeURIComponent('성과관리 면담 결과 요약');
  const body = encodeURIComponent('안녕하세요.\n\n면담 결과 요약을 공유드립니다.\n\n---\n\n' + text);
  window.location.href = `mailto:?subject=${subject}&body=${body}`;
}



// 마크다운 제거 및 가독성 향상 함수 (텍스트 처리)
function cleanReportMarkdown(text) {
    let cleanedText = text.replace(/##\s*.+\n/g, '') // ## 헤더 제거
                            .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>') // **굵은 글씨** HTML <strong> 태그로 변경
                            .replace(/-\s(.+)/g, '<li>$1</li>') // - 목록을 <li>로 변경
                            .replace(/\n\n-\s/g, '\n\n<li>') // 목록 시작 전 줄바꿈 처리
                            .replace(/\n\s*(\d+\.)\s*(.+)/g, '\n<li>$1 $2</li>') // 1. 2. 목록을 <li>로 변경
                            .replace(/\n\n/g, '<p></p>') // 이중 줄바꿈은 문단으로
                            .replace(/\n/g, '<br>') // 단일 줄바꿈은 <br>로
                            .replace(/<li>/g, '<ul><li>') // ul 태그로 감싸기
                            .replace(/<\/li><p><\/p><ul><li>/g, '</li></ul><p></p><ul><li>') // 목록 중간에 문단이 끼는 경우 방지
                            .replace(/<\/li><br><ul><li>/g, '</li></ul><br><ul><li>'); // 목록 중간에 br이 끼는 경우 방지

    // 최종적으로 ul 태그가 열려있는데 닫히지 않은 경우 처리
    if (cleanedText.includes('<ul>') && !cleanedText.includes('</ul>')) {
        cleanedText += '</ul>';
    }
    // 시작하는 <p></p> 제거
    cleanedText = cleanedText.replace(/^<p><\/p>/, '');

    // 본문 시작 시 띄어쓰기(들여쓰기) 적용 - GPT 출력에 따라 유동적으로 조정
    cleanedText = cleanedText.replace(/(\n|^)(?!<p>|<ul>|<strong>|<li>)/g, '$1&nbsp;&nbsp;');

    return cleanedText;
}
   


    
    // ===== DOM READY & ADVANCED FORM SUBMIT =====
    document.addEventListener('DOMContentLoaded', () => {
      showScreen('hero');
      var sb = document.getElementById('startBtn');
      if (sb){ sb.addEventListener('click', function(e){ e.preventDefault(); goToPersonaSelection(); }); }

      function setupCustomInput(selectId, inputId) {
        const select = document.getElementById(selectId);
        const input = document.getElementById(inputId);
        if (!select || !input) return;
        select.addEventListener('change', function() {
          input.classList.toggle('hidden', this.value !== 'custom');
        });
      }
      setupCustomInput('advPersonalityStrengthsSelect', 'advPersonalityStrengthsCustom');
      setupCustomInput('advPersonalityWeaknessesSelect', 'advPersonalityWeaknessesCustom');
      setupCustomInput('advWorkStrengthsSelect', 'advWorkStrengthsCustom');
      setupCustomInput('advWorkWeaknessesSelect', 'advWorkWeaknessesCustom');

      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      if (!SpeechRecognition) {
        const rb = document.getElementById('recordButton'); if (rb) rb.style.display = 'none';
      } else {
        const recognition = new SpeechRecognition();
        const recordButton = document.getElementById('recordButton');
        const recordStatus = document.getElementById('recordStatus');
        const textInput = document.getElementById('text');
        recognition.continuous = false; recognition.interimResults = true; recognition.lang = 'ko-KR';
        recordButton.addEventListener('click', () => { if (recordButton.classList.contains('recording')) recognition.stop(); else recognition.start(); });
        recognition.onstart = () => { recordButton.classList.add('recording'); recordStatus.textContent = '음성 인식 중...'; };
        recognition.onend = () => { recordButton.classList.remove('recording'); recordStatus.textContent = ''; };
        recognition.onerror = (e) => { recordStatus.textContent = '오류: ' + e.error; };
        recognition.onresult = (e) => {
          let finalTranscript = '';
          for (let i = e.resultIndex; i < e.results.length; ++i) { if (e.results[i].isFinal) finalTranscript += e.results[i][0].transcript; }
          if (finalTranscript) textInput.value += finalTranscript;
        };
      }
    });

    function submitAdvancedPersona() {
      function getCustomValue(selectId, inputId) {
        const select = document.getElementById(selectId);
        return select.value === 'custom' ? document.getElementById(inputId).value : select.value;
      }
      const performanceSelect = document.getElementById('advPerformance');
      const performanceValue = performanceSelect.value;
      const performanceText = performanceSelect.options[performanceSelect.selectedIndex].text;
      const performanceDetailText = document.getElementById('advPerformanceDetail').options[document.getElementById('advPerformanceDetail').selectedIndex].text;
      const autoGeneratedName = `${performanceDetailText} ${performanceText}`;
      customPersonaData = {
        name: autoGeneratedName,
        role: document.getElementById('advRole').value,
        rank: document.getElementById('advRank').value,
        years: document.getElementById('advYears').value,
        job: document.getElementById('advJob').value,
        performance: performanceValue,
        personality: `장점: ${getCustomValue('advPersonalityStrengthsSelect', 'advPersonalityStrengthsCustom')}, 단점: ${getCustomValue('advPersonalityWeaknessesSelect', 'advPersonalityWeaknessesCustom')}`,
        extra: `업무 특성 - 장점: ${getCustomValue('advWorkStrengthsSelect', 'advWorkStrengthsCustom')}, 단점: ${getCustomValue('advWorkWeaknessesSelect', 'advWorkWeaknessesCustom')} / 특이사항 - ${document.getElementById('advNotablePoints').value}`
      };
      currentPersona = performanceValue;
      useCustomAvatar = true; 
      currentMode = 'advanced';
      showScreen('stageSelection');
    }

</script>
</body>
</html>